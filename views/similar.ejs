<div id="liste-wrapper">
  <ul class="listevisning">
    <% book.similarWorks.forEach(function(similarWork,i) { %>
      <a href="/omtale" class="liste-link" >
        <li>
          <p class="liste-tittel"><%= similarWork.title %></p>
          <p class="liste-forfatter"><%= similarWork.authors %></p>
          <% var tnr = /tnr_(.*)/.exec(similarWork.bookId)[1] %>
          <input class="tnr_id" type="hidden" value="<%= tnr %>" />
          <hr style="width:100%;" />
          <div class="liste-bilde">
            <% if (similarWork.coverUrl) { %>
              <img src="<%= similarWork.coverUrl %>" class="listevisning" />
            <% } else { %>
              <div id="omtale-bilde-liste">
                <div id="inner-border-liste">
                  <div class="book-author-liste"> <% similarWork.authors %> </div>
                  <div class="book-title-liste"> <% similarWork.title %> </div>
                </div>
              </div>
            <% } %>
          </div>
        </li>
      </a>
    <% }); %>
  </ul>
</div>
<div id="fade-to-white"></div>

<script>
  $(document).ready(function () {
    $('button#avbryt-knapp').on('click', function() {
      $('#overlay').hide();
      $('#vi-leter').hide();
      if(request) {request.abort();} //abort running requests
    });

    $('a.liste-link').on('click', function(evt) {
      evt.preventDefault();
        var title = $(this).find('p.liste-tittel').html();
        var tnr = $(this).find('input.tnr_id').val();

        // Save tnr & title in case of retry
        $('#seeking_tnr').val(tnr);
        $('#seeking_title').val(title);

        // show overlay
        $('button#retry-knapp').hide();
        $('#overlay').show();
        $('button#avbryt-knapp').html('Avbryt');
        $('div#vi-leter p').html("Henter info om \"" + title + '" <div id="loading"></div>' );
        $('#vi-leter').show();

        request = $.ajax({
          url: '/populate/'+tnr,
          type: 'GET'});

        request.done(function(msg) {
          //$.get('/copy', function(data) {
            window.location.replace("/review/"+tnr);
          //});
        });

        request.fail(function(jqXHR, textStatus, errorThrown) {
          $('div#vi-leter p').html('&#9760; Beklager, dette tok for lang tid!' );
          $('button#retry-knapp').show();
          return;
        });
    });

    $('#retry-knapp').on('click', function(evt) {
      evt.preventDefault();
        var tnr = $('#seeking_tnr').val();
        var title = $('#seeking_title').val();

        // show overlay
        $('button#retry-knapp').hide();
        $('#overlay').show();
        $('button#avbryt-knapp').html('Avbryt');
        $('div#vi-leter p').html("#{Henter info om \"" + title + '" <div id="loading"></div>' );
        $('#vi-leter').show();

        request = $.ajax({
          url: '/populate/'+tnr,
          type: 'GET'});

        request.done(function(msg) {
          //$.get('/copy', function(data) {
            window.location.replace("/review/"+tnr);
          //});
        });

        request.fail(function(jqXHR, textStatus, errorThrown) {
          $('div#vi-leter p').html('&#9760; Beklager, dette tok for lang tid!' );
          $('button#retry-knapp').show();
          return;
        });
    });

  });

</script>