<div id="container" class="select-disable dim">
  <input type="hidden" id="seeking_tnr" />
  <input type="hidden" id="seeking_title" />
  <LeftBar :book :bookStable id="leftbarElement" on:snurr="chooseRandom()" on:previousBook="previousBook()" />
  <Header :book id="headerElement" />
  <Content :book :mode id="contentsElement"
    on:reviewsSameAuthorBook="reviewsSameAuthorBook(event)"
    on:reviewsSimilarWorks="reviewsSimilarWorks(event)"
    on:sameAuthorMode='set({mode: "SAME_AUTHOR"})'
    on:similarWorksMode='set({mode: "SIMILAR_WORKS"})' />
  <div id="vi-leter">
    <p>vi leter</p>
    <div id="avbryt">
      <button id="avbryt-knapp" class="top-button" on-click="cancelRequest()">Avbryt</button>
      <button id="retry-knapp" class="top-button" on-click="retryRequest()">Prøv på nytt</button>
    </div>
  </div>
  <div id="overlay"></div>

</div>

<script>
  import LeftBar from './components/LeftBar.html'
  import Header from './components/Header.html'
  import Content from './components/Content.html'
  import { distinct, solutions, bindings } from './utils/results.js'
  export default {
    data: () => ({
      err: "",
      title: "Aktive hyller",
      mode: 'REVIEWS',
      history: [],
      book: null,
      bookStable: []
    }),
    components: {
      LeftBar,
      Header,
      Content
    },
    oncreate () {
      this.chooseRandom()
    },
    methods: {
      previousBook: function() {
        console.log("previousbook")
        let stack = this.get("bookStable")
        console.log(stack.length)
        stack.pop()
        let book = stack.slice(-1)[0]
        console.log(book)
        console.log(stack.length)
        this.set({book: book, bookstable: stack})
      },

      chooseRandom: function() {
        fetch('/random')
        .then(res => { return res.json() })
        .then(uri => {
          console.log(uri)
          this.populate(uri)
        }).catch(err => console.log(err))
      },

      reviewsSameAuthorBook: function(event) {
        this.populate(event.sa.bookId)
      },

      reviewsSimilarWorks: function(event) {
        this.populate(event.sw.bookId)
      },

      populate: function(uri) {
        let b = { localReviews: [], sameAuthorBooks: [], similarWorks: []}
        fetch(`/info/${encodeURIComponent(uri)}`)
        .then(res => { return res.json() })
        .then(json => {
          b.workId  = json[0].workId.value
          b.formats = json[0].format.value
          b.title   = json[0].title.value
          b.lang    = json[0].lang.value
          b.authors = json[0].creatorName.value //extractProperties(data.solutions, ["creatorId", "creatorName"]);
          b.responsible = json[0].responsible ? json[0].responsible.value : null
          b.abstract  = json[0].abstract ? json[0].abstract.value : null
          b.krydder   = json[0].krydder ? json[0].krydder.value : null
          b.coverUrl = json[0].coverUrl ? json[0].coverUrl.value : json[0].altCoverUrl ? json[0].altCoverUrl.value : null
          return fetch(`/localreviews/${encodeURIComponent(uri)}`)
        })
        .then(res => { return res.json() })
        .then(json => {
          console.dir(json)
          b.localReviews = solutions(json)
          return fetch(`/sameauthor/${encodeURIComponent(uri)}`)
        })
        .then(res => { return res.json() })
        .then(json => {
          console.dir(json)
          b.sameAuthorBooks = solutions(json)
          return fetch(`/similarworks/${encodeURIComponent(uri)}`)
        })
        .then(res => { return res.json() })
        .then(json => {
          console.dir(json)
          b.similarWorks = solutions(json)
          return b
        })
        .then(b => {
          console.log(b)
          let stack = this.get("bookStable")
          stack.push(b)
          this.set({book: b, bookStable: stack, mode: 'REVIEWS'})
        })
        .catch(err => console.log(err))
      }
    }
  }
</script>
<style>
  /*  Global App styles */
  #container {
    width: 1680px;
    height:1049px;
    color: #222;
    border:0px solid black;
    overflow: hidden;
    background-image: url("/images/leftbar.png"); background-repeat: no-repeat;
  }

  #overlay        { position: fixed; width:100%; height: 100%; top:0; left: 0;
                       z-index: 50; background: #000; opacity: 0.8; display:none;}
  #vi-leter       { color: #fff; position:fixed; display:none;
                       top: 470px; left:0px; z-index:1000; width:1680px; text-align:center;}
  #vi-leter p        { font-size:3em; }
  #avbryt         { z-index: 1000; position: fixed; top: 570px; left: 620px;}
  #retry-knapp { display:none;}
</style>
