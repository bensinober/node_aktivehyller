<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <link href="/stylesheets/style.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="/javascripts/jquery.min.js" ></script>
  <script type="text/javascript" src="/javascripts/ractive.min.js" ></script>
  <!--
    <script type="text/javascript" src="/javascripts/rfid.js"></script>
  -->
</head>
<body>
  <div id="container" class="select-disable dim">
    <input type="hidden" id="seeking_tnr" />
    <input type="hidden" id="seeking_title" />
  <!-- Ractive Element Placeholders -->
  <!-- leftbar -->
  <div id="leftbarElement"></div>
  <!-- header -->
  <div id="headerElement"></div>
  <!-- contents -->
  <div id="contentsElement"></div>
  <!-- Ractive Templates -->



  <!-- Ractive leftbar Template -->
  <script id="leftbarTemplate" type="text/ractive">
    <div id="left-bar">
      <div class="logo"><img src="/images/logo.png" class="logo" /></div>
      {{#if (bookStable.length > 0) }}
        <button id="tilbake" class="square" on-click="previousBook"><img src="/images/tilbake.png" id="tilbake-pil"/>TILBAKE</button>
        <div id="avslutt-container">
          <button id="avslutt" class="square" on-click="close">
            <span>AVSLUTT <img src="/images/avslutt.png" id="avslutt-ikon" /></span>
          </button>
        </div>
      {{/if}}
    </div>
  </script>
  <!-- Ractive header Template -->
  <script id="headerTemplate" type="text/ractive">
    <div id="header">
      <div id="header-text">
          <p id="title">{{ title }}</p>
          <p id="sub-title">{{ authors }}</p>
      </div>
    </div>
  </script>
  <!--  Ractive contents Template 
        Uses Partials, loaded below -->

  <script id="contentsTemplate" type="text/ractive">
    <div id="contents">
      <div class="buffer"></div>
      {{>review}}
      {{>more}}
      {{>similar}}
    </div>
  </script>

    <div id="vi-leter">
      <p>vi leter</p>
      <div id="avbryt">
        <button id="avbryt-knapp" class="top-button" on-click="cancelRequest">Avbryt</button>
        <button id="retry-knapp" class="top-button" on-click="retryRequest">Prøv på nytt</button>
      </div>
    </div>
    <div id="overlay"></div>
  </div>

<script type="text/javascript">
  /*
   * LEFT-BAR RACTIVE
   */
  var bookStable = [];
  var leftbarRactive = new Ractive({
      el: "#leftbarElement",
      template: "#leftbarTemplate",
      data: { bookStable: bookStable }
  });

  // Events
  leftbarRactive.on({
    previousBook: function(event) {
      bookStable.pop();            // remove one from stack
      var book = bookStable[bookStable.length - 1];   // select last
      console.log(book);
      headerRactive.set({title: book.title, authors: book.authors});
      contentsRactive.set({book: book});
    },
    close: function(event) {
      console.log(event);
    }
  });
</script>
<script type="text/javascript">
  /*
   * HEADER RACTIVE
   */
  var headerRactive = new Ractive({
      el: "#headerElement",
      template: "#headerTemplate",
      data: { title: "Rummy Dummy", authors: "Some One" }
  });
</script>
<script type="text/javascript">
  /*
   * CONTENTS RACTIVE
   */
  var exampleBook = {
    bookId: "http://data.deichman.no/resource/tnr_1430248",
    title: "Rampete Robin",
    authors: "Punk Cody",
    coverUrl: "http://www.bokkilden.no/SamboWeb/servlet/VisBildeServlet?produktId=8973271",
    localReviews: [ 
      {
        reviewText: "Some shit about the book, bla bla bla...",
        reviewSource: "Komintern"
      }
    ],
    sameAuthorBooks: [
      {
        bookId: "http://data.deichman.no/resource/tnr_1430248",
        title: "Rampete Robin",
        authors: "Wim Wam",
        coverUrl: "http://www.bokkilden.no/SamboWeb/servlet/VisBildeServlet?produktId=8973271"
      } 
    ],
    similarWorks: [
      {
        bookId: "http://data.deichman.no/resource/tnr_621959",
        title: "Alle mine kjære",
        authors: "Soma Catu",
        coverUrl: "http://krydder.bib.no/0047/828961.bilde.1327545784.s.jpg"
      }
    ]
  }

  var partials = {}, promises, contentsRactive;

  promises = [ 'review','more', 'similar' ].map( function ( name ) {
    return $.ajax( 'partials/' + name + '.html' ).then( function ( response ) {
      partials[ name ] = response;
    });
  });

  Promise.all( promises ).then( function () {
    contentsRactive = new Ractive({
      el: '#contentsElement',
      template: '#contentsTemplate',
      partials: partials,
      data: { reviewMode: true, moreFromAuthorMode: false, similarWorkMode: false, book: exampleBook }
    });

    // Session history - Object to be saved in session storage
    var history = [];

    // Events
    contentsRactive.on({
      lookupBook: function(event) {
        var tnr = /tnr_(.*)/.exec(event.context.bookId)[1];
        console.log(tnr);
        // TODO: Rewrite into ractive
        // show overlay
        $('button#retry-knapp').hide();
        $('#overlay').show();
        $('button#avbryt-knapp').html('Avbryt');
        $('div#vi-leter p').html("Henter info om \"" + event.context.title + '" <div id="loading"></div>' );
        $('#vi-leter').show();
        request = $.ajax({
          url: '/populate/'+tnr,
          type: 'GET'});

        request.done(function(response) {
          // successful request - populate App!
          console.log(response);
          contentsRactive.set({book: response, reviewIndex: 0, reviewMode: true, moreFromAuthorMode: false, similarWorkMode: false});
          var authors = [];
          // comma, separated authors list
          response.authors.forEach(function(a) {
            authors.push(a.creatorName);
          });
          headerRactive.set({title: response.title, authors: authors.join(', ') });

          // save to history
          leftbarRactive.data.bookStable.push(response);

          $('#overlay').hide();
          $('#vi-leter').hide();
        });
        request.fail(function(jqXHR, textStatus, errorThrown) {
          $('div#vi-leter p').html('&#9760; Beklager, dette tok for lang tid!' );
          $('button#retry-knapp').show();
          return;
        });
      },
      cancelRequest: function(event) {
        console.dir(event.context);
        if(request) {request.abort();} //abort running requests
      },
      nextReview: function() {
        var idx = contentsRactive.get("reviewIndex");
        idx++;
        contentsRactive.set({reviewIndex: idx});
      },
      previousReview: function() {
        var idx = contentsRactive.get("reviewIndex");
        idx--;
        contentsRactive.set({reviewIndex: idx});
      },
      moreAuthorBooks: function() {
        contentsRactive.set({reviewMode: false, moreFromAuthorMode: true, similarWorkMode: false});
      },
      moreSimilarBooks: function() {
        contentsRactive.set({reviewMode: false, moreFromAuthorMode: false, similarWorkMode: true});
      }
    });
  });

</script>
</body>
</html>