<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <link href="/stylesheets/style.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="/javascripts/jquery.min.js" ></script>
  <script type="text/javascript" src="/javascripts/ractive.min.js" ></script>
  <!--
    <script type="text/javascript" src="/javascripts/rfid.js"></script>
  -->
</head>
<body>
  <div id="container" class="select-disable dim">
    <input type="hidden" id="seeking_tnr" />
    <input type="hidden" id="seeking_title" />
  <!-- Ractive Element Placeholders -->
  <!-- leftbar -->
  <div id="leftbarElement"></div>
  <!-- header -->
  <div id="headerElement"></div>
  <!-- contents -->
  <div id="contentsElement"></div>
  <!-- Ractive Templates -->



  <!-- Ractive leftbar Template -->
  <script id="leftbarTemplate" type="text/ractive">
    <div id="left-bar">
      <div class="logo"><img src="/images/logo.png" class="logo" /></div>
      <!-- TODO: session history -->
      {{#if (session.history.length > 0) }}
        <a href="/back">
          <button id="tilbake" class="square"><img src="/images/tilbake.png" id="tilbake-pil"/>TILBAKE</button>
        </a>
      <div id="avslutt-container">
        <a href="/">
          <button id="avslutt" class="square">
            <span>AVSLUTT <img src="/images/avslutt.png" id="avslutt-ikon" /></span>
          </button>
        </a>
      </div>
      {{/if}}
    </div>
  </script>
  <!-- Ractive header Template -->
  <script id="headerTemplate" type="text/ractive">
    <div id="header">
      <div id="header-text">
          <p id="title">{{ book.title }}</p>
          <p id="sub-title">{{ book.authors }}</p>
      </div>
    </div>
  </script>
  <!--  Ractive contents Template 
        Uses Partials, loaded below -->

  <script id="contentsTemplate" type="text/ractive">
      {{>review}}
      {{>more}}
      {{>similar}}
  </script>

    <div id="vi-leter">
      <p>vi leter</p>
      <div id="avbryt">
        <button id="avbryt-knapp" class="top-button" on-click="cancelRequest">Avbryt</button>
        <button id="retry-knapp" class="top-button" on-click="retryRequest">Prøv på nytt</button>
      </div>
    </div>
    <div id="overlay"></div>
  </div>

<script type="text/javascript">
  /*
   * LEFT-BAR RACTIVE
   */
  var leftbarRactive = new Ractive({
      el: "#leftbarElement",
      template: "#leftbarTemplate",
      data: { }
  });
</script>
<script type="text/javascript">
  /*
   * HEADER RACTIVE
   */
  var headerRactive = new Ractive({
      el: "#headerElement",
      template: "#headerTemplate",
      data: { }
  });
</script>
<script type="text/javascript">
  /*
   * CONTENTS RACTIVE
   */
  var exampleBook = {
    bookId: "http://data.deichman.no/resource/tnr_1430248",
    title: "Rampete Robin",
    authors: "Punk Cody",
    coverUrl: "http://www.bokkilden.no/SamboWeb/servlet/VisBildeServlet?produktId=8973271",
    localReviews: [ 
      {
        reviewText: "Some shit about the book, bla bla bla...",
        reviewSource: "Komintern"
      }
    ],
    sameAuthorBooks: [
      {
        bookId: "http://data.deichman.no/resource/tnr_1430248",
        title: "Rampete Robin",
        authors: "Wim Wam",
        coverUrl: "http://www.bokkilden.no/SamboWeb/servlet/VisBildeServlet?produktId=8973271"
      } 
    ],
    similarWorks: [
      {
        bookId: "http://data.deichman.no/resource/tnr_621959",
        title: "Alle mine kjære",
        authors: "Soma Catu",
        coverUrl: "http://krydder.bib.no/0047/828961.bilde.1327545784.s.jpg"
      }
    ]
  }

  var ractive, partials = {}, promises;

  promises = [ 'review','more', 'similar' ].map( function ( name ) {
    return $.ajax( 'partials/' + name + '.html' ).then( function ( response ) {
      partials[ name ] = response;
    });
  });

  Promise.all( promises ).then( function () {
    var contentsRactive = new Ractive({
      el: '#contentsElement',
      template: '#contentsTemplate',
      partials: partials,
      data: { reviewMode: true, moreFromAuthorMode: false, similarWorkMode: false, book: exampleBook }
    });

    // events
    contentsRactive.on({
      lookupBook: function(event) {
        // HERE!
        console.dir(event.context);
        var tnr = /tnr_(.*)/.exec(event.context.bookId)[1];
        console.log(tnr);
        // TODO: Rewrite into ractive
        // show overlay
        $('button#retry-knapp').hide();
        $('#overlay').show();
        $('button#avbryt-knapp').html('Avbryt');
        $('div#vi-leter p').html("Henter info om \"" + event.context.title + '" <div id="loading"></div>' );
        $('#vi-leter').show();
        request = $.ajax({
          url: '/populate/'+tnr,
          type: 'GET'});

        request.done(function(msg) {
          console.log(msg);
          contentsRactive.set({book: msg});
          $('#overlay').hide();
          $('#vi-leter').hide();
        });
        request.fail(function(jqXHR, textStatus, errorThrown) {
          $('div#vi-leter p').html('&#9760; Beklager, dette tok for lang tid!' );
          $('button#retry-knapp').show();
          return;
        });
      },
      cancelRequest: function(event) {
        console.dir(event.context);
        if(request) {request.abort();} //abort running requests
      }
    });
  });

</script>
</body>
</html>